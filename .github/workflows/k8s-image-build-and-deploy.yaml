name: k8s image build & deploy (GitOps)

on:
  push:
    branches: [main, stage]
    # Prevent CI loop: this workflow will commit into k8s/ to bump image tags.
    paths-ignore:
      - 'k8s/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

concurrency:
  group: k8s-image-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-push-and-bump-k8s:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set variables
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          echo "sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          echo "sha_short=${GITHUB_SHA:0:12}" >> "$GITHUB_OUTPUT"

          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "overlay_dir=k8s/apps/litomi/overlays/prod" >> "$GITHUB_OUTPUT"
            echo "env_name=prod" >> "$GITHUB_OUTPUT"
          elif [ "${GITHUB_REF_NAME}" = "stage" ]; then
            echo "overlay_dir=k8s/apps/litomi/overlays/stg" >> "$GITHUB_OUTPUT"
            echo "env_name=stg" >> "$GITHUB_OUTPUT"
          else
            echo "Unsupported branch: ${GITHUB_REF_NAME}" >&2
            exit 1
          fi

          echo "image_web=ghcr.io/${GITHUB_REPOSITORY_OWNER}/litomi-web" >> "$GITHUB_OUTPUT"
          echo "image_backend=ghcr.io/${GITHUB_REPOSITORY_OWNER}/litomi-backend" >> "$GITHUB_OUTPUT"

          image_web="ghcr.io/${GITHUB_REPOSITORY_OWNER}/litomi-web"
          image_backend="ghcr.io/${GITHUB_REPOSITORY_OWNER}/litomi-backend"

          # Tag strategy:
          # - Deploy: immutable tag (= commit SHA)
          # - Convenience: branch tag (main/stage) and latest (main only)
          echo "tags_web<<EOF" >> "$GITHUB_OUTPUT"
          echo "${image_web}:${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          echo "${image_web}:${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "${image_web}:latest" >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "tags_backend<<EOF" >> "$GITHUB_OUTPUT"
          echo "${image_backend}:${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          echo "${image_backend}:${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "${image_backend}:latest" >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Extract NEXT_PUBLIC_* build args from k8s overlay
        id: public_env
        shell: bash
        run: |
          set -euo pipefail

          file="${{ steps.vars.outputs.overlay_dir }}/kustomization.yaml"
          tmp="$(mktemp)"

          # NOTE: This expects `configMapGenerator.literals` lines like:
          #   - NEXT_PUBLIC_BACKEND_URL=https://...
          # We treat the overlay as the source of truth to avoid duplication in CI.
          grep -E '^[[:space:]]*-[[:space:]]+NEXT_PUBLIC_[A-Z0-9_]+=.*$' "$file" \
            | sed -E 's/^[[:space:]]*-[[:space:]]+//' \
            > "$tmp"

          echo "build_args<<EOF" >> "$GITHUB_OUTPUT"
          cat "$tmp" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.hono
          platforms: linux/arm64
          push: true
          tags: |
            ${{ steps.vars.outputs.tags_backend }}

      - name: Build & push web image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.nextjs
          platforms: linux/arm64
          push: true
          build-args: |
            CI=true
            COMMIT_SHA=${{ steps.vars.outputs.sha_short }}
            ${{ steps.public_env.outputs.build_args }}
          tags: |
            ${{ steps.vars.outputs.tags_web }}

      - name: Bump k8s overlay image tags (GitOps)
        shell: bash
        run: |
          set -euo pipefail

          file="${{ steps.vars.outputs.overlay_dir }}/kustomization.yaml"

          # Replace both image tags under `images:` with the new immutable tag.
          # (newName stays constant; only newTag changes per commit)
          python3 - <<'PY'
          import pathlib, re, sys

          path = pathlib.Path("${{ steps.vars.outputs.overlay_dir }}/kustomization.yaml")
          tag = "${{ steps.vars.outputs.sha }}"
          s = path.read_text(encoding="utf-8")

          # Update every `newTag: ...` line (there are exactly 2 in this file for litomi-web/litomi-backend).
          s2, n = re.subn(r"^(\s*newTag:\s*).+$", r"\1" + tag, s, flags=re.M)
          if n < 2:
            print(f"Expected to update >= 2 newTag lines, but updated {n}", file=sys.stderr)
            sys.exit(1)

          path.write_text(s2, encoding="utf-8")
          PY

          git diff -- "$file"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$file"
          git commit -m "chore(k8s): deploy ${{ steps.vars.outputs.env_name }} @ ${{ steps.vars.outputs.sha_short }} [skip ci]"
          git push
