## PRD: 브라우저(WebGPU) 온디바이스 이미지 생성

### 1) 배경/문제

이미지 생성 기능을 제공하고 싶지만, 일반적인 클라우드 GPU 서버 방식은 생성량이 늘수록 비용이 선형으로 증가합니다.  
본 기능은 **연산을 사용자 디바이스로 이동(온디바이스)** 하여 **서버 비용을 최소화**하면서도, **1024 품질 우선** 사용 경험을 목표로 합니다.

### 2) 목표(Goals)

- **G1. 완전 웹**: 앱 설치 없이 브라우저에서만 동작
- **G2. 온디바이스**: 서버에서 이미지 생성/저장하지 않음(클라우드 GPU 0)
- **G3. 모델 전환 UX**: 사용자가 여러 모델을 수시로 바꿔 사용 가능(단, 동시 로드는 1개)
- **G4. 고품질**: 기본 1024 생성(성능 부족 시 768 허용)
- **G5. 대기 UX 개선**: 생성 중 **프리뷰/진행률/취소** 제공

### 3) 비목표(Non-goals)

- 모바일 지원
- 서버 fallback(하이브리드)
- NSFW/유해 프롬프트 필터링
- 생성 결과의 서버 저장/공유(로컬 저장만)
- 학습/파인튜닝(LoRA training, DreamBooth 등)

### 4) 타깃 사용자/플랫폼

- **OS**: Windows 노트북, macOS
- **브라우저**: Chrome/Edge(Chromium) only
- **필수 조건**: WebGPU 지원

### 5) 핵심 사용자 시나리오(User stories)

- **US1**: 사용자는 “모델 선택”에서 원하는 모델을 고르고, 필요 시 다운로드 설치 후 프롬프트로 이미지를 생성한다.
- **US2**: 사용자는 생성 도중 **중간 프리뷰**를 보고, 마음에 안 들면 **취소**한다.
- **US3**: 사용자는 생성 결과를 **로컬로 저장**한다.
- **US4(후순위)**: 사용자는 모델 설치가 실패하면(예: CORS/네트워크) **로컬 파일 Import**로 모델을 추가한다.
- **US5**: 사용자는 저장공간을 확보하기 위해 설치된 모델을 삭제한다.

### 6) 기능 요구사항(Functional requirements)

- **FR1 WebGPU 지원 확인**
  - `navigator.gpu` 존재 + `requestAdapter()` 성공 여부로 판별
  - 미지원 시 안내 페이지/모달로 전환
- **FR2 성능 측정(미니 벤치)**
  - 최초 실행 시 짧은 워밍업으로 대략적인 성능 등급 산정
  - 성능 기반 기본 프리셋 자동 선택(1024/768, step 기본값 등)
- **FR3 모델 관리**
  - 모델 목록(레지스트리) 제공
  - “모델 다운로드(온라인)” 제공(Import는 후순위)
  - 설치/삭제/상태(미설치/다운로드중/설치됨/오류) 표시
  - 설치된 모델은 **OPFS**에 영속 저장
- **FR4 이미지 생성**
  - 프롬프트(positive), 네거티브(선택), 시드(선택), steps/CFG/샘플러(모델 기본값 제공, 고급 설정으로 숨김)
  - 생성 중 진행률 표시 + 중간 프리뷰 + 취소
  - 완료 후 결과 미리보기 + “로컬 저장(PNG)” 제공
  - 생성 결과 **OPFS 자동 저장 옵션** 제공(기본값은 제품 정책에 따름)
- **FR5 모델 전환**
  - 한 번에 한 모델만 로드(다른 모델로 전환 시 현재 세션 dispose)

### 7) 비기능 요구사항(Non-functional requirements)

- **성능 목표(초기 가이드, 기기별 편차 허용)**
  - 1024는 “완료까지 시간이 오래 걸려도 OK” 전제(2분 초과 허용)
  - 다만 사용자 체감을 위해 프리뷰는 가능한 빠르게(기기별 편차 허용)
- **안정성**
  - WebGPU `device lost`, OOM 등 실패에서 “재시도/프리셋 다운(768/step 감소)”로 복구 경로 제공
- **프라이버시**
  - 프롬프트/이미지 서버 전송 없음(단, 오류 텔레메트리는 최소 수집 가능)

### 8) 성공 지표(Success metrics)

- **기능 지표**
  - WebGPU 지원 통과율
  - 모델 설치 성공률/평균 설치 시간
  - 생성 성공률(완료/취소/실패 비율)
- **성능 지표**
  - 첫 프리뷰까지 시간
  - 전체 생성 시간 분포(기기 등급별)
  - OOM / device lost 발생률
- **사용 지표(선택)**
  - 모델별 사용 비중
  - 재방문/재생성율

### 9) 범위(모델)

- 목표: Stable Diffusion 계열(특히 SDXL급) 스타일 모델(일러스트/반실사/실사)
- 런타임에서 바로 로드 가능한 번들을 기본 단위로 사용(초기: **ONNX 번들**, 대안: **MLC/TVM 컴파일 아티팩트**)
- 모델은 Hugging Face 등 공개 호스팅에서 제공(또는 Import)

### 10) 오픈 이슈/결정 필요

- (DONE) 모델 레지스트리(기본 3개)
  - PerfectDeliberate(반실사) / Pony Realism(실사) / WAI Illustrious SDXL(2D 일러스트)
- (DONE) 텔레메트리 수집 범위: 익명 성능/에러만 최소 수집(Sentry/GA)
- (PHASE2) 모델 Import 포맷(zip 단일 vs 폴더 선택)
- (TODO) 런타임 선택: ORT(WebGPU)+ONNX vs MLC/TVM(컴파일)
- (TODO) SDXL Refiner 정책: 포함 여부/옵션/다운로드 구조(용량·시간·품질 트레이드오프)
