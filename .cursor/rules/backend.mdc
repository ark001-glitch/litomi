---
alwaysApply: false
globs:
  - 'src/backend/**'
  - 'src/app/**/action*.ts'
---

## Database & Migrations

- **Use `drizzle-kit push` as the primary workflow** (via `bun run db:push:*`) to sync schema to DB.
- Drizzle schema files are organized by domain under `src/db/schema/*` and referenced explicitly from `drizzle.config.ts`.

### Drizzle (Postgres / Supabase) Rules

- **Push-first (including production)**:
  - Never run a production push unless the user explicitly asks for it (high blast radius).
  - Before pushing, ensure the target DB is correct (dev vs prod env vars) and push to staging first when available.

- **Do not commit generated drizzle output**:
  - Keep generated outputs (e.g. `drizzle/**`) out of git.
  - Schema changes are reviewed via the schema code changes (not generated migration artifacts).

- **Naming conventions**:
  - DB table/column names: **snake_case**.
  - TypeScript property keys: **camelCase** (e.g. `createdAt: timestamp('created_at', ...)`).

- **Primary keys (identity)**:
  - Use identity PKs: `.primaryKey().generatedByDefaultAsIdentity()`.
  - IDs are generated by the DB (no app-generated IDs for Postgres identity tables).

- **Timestamps**:
  - Use `timestamp('...', { precision: 3, withTimezone: true })`.
  - Prefer `created_at` + `updated_at` columns.

- **RLS (Supabase)**:
  - All Supabase tables must call `.enableRLS()`.
  - Never disable RLS unless the user explicitly approves and the reason is documented.

- **Constraints & indexes (DB-level enforcement)**:
  - Prefer DB-enforced constraints: `notNull`, `unique`, `references` (FK), `check`.
  - Add indexes intentionally:
    - Index FK columns used in joins/filters.
    - Index columns used in frequent `where` predicates and order-by columns.

- **Query conventions (readability + performance)**:
  - Default to selecting only what you need:
    - ✅ `.select({ id: table.id, createdAt: table.createdAt })`
    - ⚠️ `.select()` is allowed only when selecting the full row is intentional (add a short comment).
  - Prefer explicit `join` (`innerJoin`, `leftJoin`) over relation sugar when the join logic matters.

- **Raw SQL policy (strict)**:
  - ✅ Allowed: `sql\`\`` fragments for expressions/CASE/updates when needed.
  - ✅ Allowed: `sql.identifier(...)` for dynamic identifiers.
  - ❌ Forbidden: `sql.raw(...)` and building SQL via string concatenation.

```ts
// ✅ Good: safe excluded-column reference without sql.raw
import { sql } from 'drizzle-orm'

const excludedToken = sql`excluded.${sql.identifier('token')}`
```

- **bigint mapping guidance**:
  - Prefer `bigint({ mode: 'number' })` for identity IDs and values that will never exceed `Number.MAX_SAFE_INTEGER`.
  - If a column may exceed `Number.MAX_SAFE_INTEGER`, use `bigint({ mode: 'bigint' })` and serialize it as a string at API boundaries.

## Security

### Rate Limiting

- **IP-based rate limiting is managed at the infrastructure level** (e.g., CDN, load balancer, reverse proxy).
- Do NOT implement IP-based rate limiting in application code.
- For user-specific rate limiting (e.g., login attempts), use email/account-based tracking instead of IP.
